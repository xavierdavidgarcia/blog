<!doctype html>
<html>
<head>
    <base href="/">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="author" content="Xavier Garcia">

<meta name="description" content="">

<title>Install DRDB Cluster on Centos 7</title>
<meta name="generator" content="Hugo 0.57.2" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/pojoaque.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
<link  href="/css/theme.min.css" rel="stylesheet" type="text/css">

</head>
<body>
<div class="page-container container-fluid">
<div class="col-md-3 menu">
    <nav class="col-md-3">
    <h3 class="home-link"><a href="https://xavier-garcia.com">Root</a></h3>
    <div id="last-posts" class="open">
        <h3 data-open="last-posts">Xavier Garcia - Most recent posts</h3>
        <ul>
            
            <li><a href="/post/minikube-and-debian9/">How to setup minikube lab on debian 9 with virtualbox</a></li>
            
            <li><a href="/post/moving_kops_aws_kubernetes_api_from_public_to_internal_elb/">Moving Kops Aws Kubernetes API from Public to Internal ELB</a></li>
            
            <li><a href="/post/how_to_create_a_helm_chart_repository_using_amazon_s3/">How to create a Helm chart repository using Amazon S3</a></li>
            
            <li><a href="/post/configure_automatically_external_dns_on_kubernetes/">Configure automatically external dns on Kubernetes</a></li>
            
            <li><a href="/post/manage_your_friends_with_microservice_in_golang/">Manage your friends with a microservice in Golang</a></li>
            
            <li><a href="/post/what_is_tensor_flow/">What is TensorFLow</a></li>
            
            <li><a href="/post/deploy_kubernetes_cluster_with_kops/">Deploy Kubernetes cluster with Kops and AWS s3 state</a></li>
            
            <li><a href="/post/install_lets_encrypt_debian_9_nginx/">Install Let&#39;s Encrypt with Nginx on Debian 9</a></li>
            
            <li><a href="/post/design_patterns_in_golang-part-5/">Design Patterns in Golang - Part-5</a></li>
            
            <li><a href="/post/design_patterns_in_golang-part-4/">Design Patterns in Golang - Part-4</a></li>
            
            <li><a href="/post/design_patterns_in_golang-part-3/">Design Patterns in Golang - Part-3</a></li>
            
            <li><a href="/post/design_patterns_in_golang-part-2/">Design Patterns in Golang - Part-2</a></li>
            
            <li><a href="/post/design_patterns_in_golang-part-1/">Design Patterns in Golang - Part-1</a></li>
            
            <li><a href="/post/how_do_i_get_the_certificate_authority_certificate_key/">How do I get the certificate authority certificate/key from a cluster created by kops?</a></li>
            
            <li><a href="/post/install_drdb_cluster_on_centos_7/">Install DRDB Cluster on Centos 7</a></li>
            
            <li><a href="/post/write_functions_in_functional_programming_style_in_scala/">Write Functions In Functional Programming Style In Scala</a></li>
            
            <li><a href="/post/decision_trees_in_python/">Decision trees in python</a></li>
            
            <li><a href="/post/logistic_regression_in_python/">Logistic Regression in python</a></li>
            
            <li><a href="/post/linear_regression_in_python/">Linear Regression in python</a></li>
            
            <li><a href="/post/clean_clean_my_docker/">Clean clean my docker</a></li>
            
            <li><a href="/post/my_docker_alias/">Docker alias for your zsh</a></li>
            
            <li><a href="/post/encryption_with_rsa/">Encryption with an RSA</a></li>
            
            <li><a href="/post/how_to_write_good_post_mortem/">How to Write a good post mortem</a></li>
            
            <li><a href="/post/how_to_write_product_requirements_document/">How to Write a Product Requirements Document (PRD)</a></li>
            
            <li><a href="/post/curl_http-2_support/">cURL HTTP/2 support</a></li>
            
            <li><a href="/post/template-7/">Bindwith PostgreSQL backend at CentOS 6.4</a></li>
            
            <li><a href="/post/how_to_install_and_configure_glusterfs_server_on_ubuntu/">How to install and configure GlusterFS Server on Ubuntu</a></li>
            
            <li><a href="/post/template-5/">Linear Regression in python</a></li>
            
            <li><a href="/post/ipv6_on_ubiquity_edge_router_lite/">Activate IPv6 on Ubiquity Edge router lite</a></li>
            
        </ul>
    </div>

    
    <div id="tags" class="open">
        <h3 data-open="tags">Tags</h3>
        <ul class="tags" style="display: none;">
            
            <li><a href="/tags/agile">agile</a></li>
            
            <li><a href="/tags/aws">aws</a></li>
            
            <li><a href="/tags/centos">centos</a></li>
            
            <li><a href="/tags/code">code</a></li>
            
            <li><a href="/tags/container">container</a></li>
            
            <li><a href="/tags/curl">curl</a></li>
            
            <li><a href="/tags/debian">debian</a></li>
            
            <li><a href="/tags/design">design</a></li>
            
            <li><a href="/tags/designpattern">designpattern</a></li>
            
            <li><a href="/tags/dev">dev</a></li>
            
            <li><a href="/tags/development">development</a></li>
            
            <li><a href="/tags/devops">devops</a></li>
            
            <li><a href="/tags/dns">dns</a></li>
            
            <li><a href="/tags/docker">docker</a></li>
            
            <li><a href="/tags/drdb">drdb</a></li>
            
            <li><a href="/tags/encrypt">encrypt</a></li>
            
            <li><a href="/tags/filesystem">filesystem</a></li>
            
            <li><a href="/tags/functional">functional</a></li>
            
            <li><a href="/tags/glusterfs">glusterfs</a></li>
            
            <li><a href="/tags/go">go</a></li>
            
            <li><a href="/tags/golang">golang</a></li>
            
            <li><a href="/tags/helm">helm</a></li>
            
            <li><a href="/tags/http">http</a></li>
            
            <li><a href="/tags/ipv6">ipv6</a></li>
            
            <li><a href="/tags/kops">kops</a></li>
            
            <li><a href="/tags/kubernetes">kubernetes</a></li>
            
            <li><a href="/tags/lab">lab</a></li>
            
            <li><a href="/tags/letsencrypt">letsencrypt</a></li>
            
            <li><a href="/tags/linux">linux</a></li>
            
            <li><a href="/tags/machinelearning">machinelearning</a></li>
            
            <li><a href="/tags/microservice">microservice</a></li>
            
            <li><a href="/tags/minikube">minikube</a></li>
            
            <li><a href="/tags/mongodb">mongodb</a></li>
            
            <li><a href="/tags/network">network</a></li>
            
            <li><a href="/tags/nginx">nginx</a></li>
            
            <li><a href="/tags/postmortem">postmortem</a></li>
            
            <li><a href="/tags/prd">prd</a></li>
            
            <li><a href="/tags/product">product</a></li>
            
            <li><a href="/tags/project_management">project_management</a></li>
            
            <li><a href="/tags/python">python</a></li>
            
            <li><a href="/tags/router">router</a></li>
            
            <li><a href="/tags/rsa">rsa</a></li>
            
            <li><a href="/tags/s3">s3</a></li>
            
            <li><a href="/tags/scala">scala</a></li>
            
            <li><a href="/tags/scrum">scrum</a></li>
            
            <li><a href="/tags/security">security</a></li>
            
            <li><a href="/tags/shell">shell</a></li>
            
            <li><a href="/tags/ssh">ssh</a></li>
            
            <li><a href="/tags/ssl">ssl</a></li>
            
            <li><a href="/tags/startup">startup</a></li>
            
            <li><a href="/tags/tensorflow">tensorflow</a></li>
            
            <li><a href="/tags/ubiquity">ubiquity</a></li>
            
        </ul>
    </div>
    

    
</nav>

</div>
<div class="col-md-9 content">

<h1>Install DRDB Cluster on Centos 7</h1>
<h4>Published 08-15-2017 00:00:00</h4>

<article>
    

<h4 id="what-is-drbd-distributed-replicated-block-device">What is DRBD (Distributed Replicated Block Device)?</h4>

<p>DRBD (Distributed Replicated Block Device) is a Linux-based software component to mirror or replicate individual storage devices (such as hard disks or partitions) from one node to the other(s) over a network connection. DRBD makes it possible to maintain consistency of data among multiple systems in a network. DRBD also ensures high availability (HA) for Linux applications.
DRBD supports three distinct replication modes, allowing three degrees of replication synchronicity.</p>

<ul>
<li>Protocol A: Asynchronous replication protocol.</li>
<li>Protocol B: Memory synchronous (semi-synchronous) replication protocol.</li>
<li>Protocol C: Synchronous replication protocol.</li>
</ul>

<p>In this tutorial, we are going to create and configure a DRBD Cluster Across two servers. Both servers have an empty disk attached /dev/sdb.</p>

<h4 id="enviroment">Enviroment</h4>

<pre><code>drbd01.test.local	192.168.1.20	CentOS 7
drbd02.test.local	192.168.1.21	CentOS 7
</code></pre>

<h4 id="installing-drbd">Installing DRBD</h4>

<p>In order to install DRBD, you will need to enable the ELRepo repository on both nodes, because this software package is not distributed through the standard CentOS and Red Hat Enterprise Linux repositories.
Use the following commands to import GPG key and install ELRepo repository on both nodes:</p>

<pre><code># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
# rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
</code></pre>

<p>Run the following command on both nodes to install the DRBD software and the all necessaries kernel modules</p>

<pre><code># yum install drbd90-utils kmod-drbd90
</code></pre>

<p>– Once the installation is completed, you will need to check whether the kernel module is loaded correctly, using this command:</p>

<pre><code># lsmod | grep -i drbd
</code></pre>

<p>If it is not loaded automatically, you can load the module to the kernel on both nodes, using the follow command:</p>

<pre><code># modprobe drbd
</code></pre>

<p>Note that modprobe command will take care of loading the kernel module for the time being on your current session. However, in order for it to be loaded during boot, you have to make use of the systemd-modules-load service by creating a file inside /etc/modulesload.d/ so that the DRBD module is loaded properly each time the system boots:</p>

<pre><code># echo drbd &gt; /etc/modules-load.d/drbd.conf
</code></pre>

<h4 id="configuring-drbd">Configuring DRBD</h4>

<p>After having successfully installed DRBD on both nodes, we need to modify the DRBD global and common settings by editing the file /etc/drbd.d/global_common.conf.</p>

<p>Let’s backup the original settings on both nodes with the following command:</p>

<pre><code># mv /etc/drbd.d/global_common.conf /etc/drbd.d/global_common.conf.orig
</code></pre>

<p>Create a new global_common.conf file on both nodes with the following contents:</p>

<pre><code># vi /etc/drbd.d/global_common.conf
global {
 usage-count no;
}
common {
 net {
  protocol C;
 }
}
</code></pre>

<p>Next, we will need to create a new configuration file called /etc/drbd.d/drbd0.res for the new resource named drbd0, with the following contents:</p>

<pre><code># vi /etc/drbd.d/drbd0.res
resource drbd0 {
	disk /dev/sdb;
	device /dev/drbd0;
	meta-disk internal;
	on drbd01 {
		address 192.168.1.20:7789;
	}
	on drbd02 {
		address 192.168.1.21:7789;
	}
}
</code></pre>

<p>In the above resource file, we created a new resource drbd0 where 192.168.1.20 and 192.168.1.21 are the IP addresses of our two nodes, and 7789 is the port used for communication, using the disk /dev/sdb to create the new device /dev/drbd0.</p>

<p>Initialize the meta data storage on each nodes by executing the following command on both nodes</p>

<pre><code># drbdadm create-md drbd0
</code></pre>

<p>Starting and Enabling the DRBD Daemon on both nodes.</p>

<pre><code># systemctl start drbd
# systemctl enable drbd
</code></pre>

<p>Lets define the DRBD Primary node as first node “ylpldrbd01”.</p>

<pre><code># drbdadm up drbd
# drbdadm primary drbd
</code></pre>

<blockquote>
<p>Note:
if you get any error to make the node primary, use the following command to forcefully make the node as primary:</p>

<pre><code># drbdadm primary drbd --force
</code></pre>

<p>You can check the current status of the synchronization while it’s being performed. The cat /proc/drbd command displays the creation and synchronization progress of the resource, as shown here:</p>

<pre><code># cat /proc/drbd
</code></pre>

<p>Adjust the firewall using the following commands:</p>

<pre><code># firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source address=&quot;ip_address&quot; port port=&quot;7789&quot; protocol=&quot;tcp&quot; accept'
# firewall-cmd --reload
</code></pre>

<h4 id="test-the-drbd">Test the DRBD</h4>

<p>In order to test the DRBD functionality we need to Create a file system, mount the volume and write some data on primary node “ylpldrbd01” and finally switch the primary node to “ylpldrbd02”</p>
</blockquote>

<p>– Run the following command on the primary node to create an xfs filesystem on /dev/drbd0 and mount it to the mnt directory, using the following commands:</p>

<pre><code># mkfs.xfs /dev/drbd0
# mount /dev/drbd0 /mnt
</code></pre>

<p>– Create some data using the following command:</p>

<pre><code># touch /mnt/file{1..5}
# ls -l /mnt/
total 0
-rw-r--r--. 1 root root 0 Sep 22 21:43 file1
-rw-r--r--. 1 root root 0 Sep 22 21:43 file2
-rw-r--r--. 1 root root 0 Sep 22 21:43 file3
-rw-r--r--. 1 root root 0 Sep 22 21:43 file4
-rw-r--r--. 1 root root 0 Sep 22 21:43 file5
</code></pre>

<p>– Let’s now switch primary mode “drbd01” to second node “```drbd02” to check the data replication works or not.</p>

<p>First, we have to unmount the volume drbd0 on the first drbd cluster node “drbd01”.</p>

<pre><code># umount /mnt
</code></pre>

<p>Change the primary node to secondary node on the first drbd cluster node “drbd01”</p>

<pre><code># drbdadm secondary drbd
</code></pre>

<p>Change the secondary node to primary node on the second drbd cluster node “drbd02”</p>

<pre><code># drbdadm primary drbd
</code></pre>

<p>Mount the volume and check the data available or not.</p>

<pre><code># mount /dev/drbd0 /mnt
# ls -l  /mnt
total 0
-rw-r--r--. 1 root root 0 Sep 22 21:43 file1
-rw-r--r--. 1 root root 0 Sep 22 21:43 file2
-rw-r--r--. 1 root root 0 Sep 22 21:43 file3
-rw-r--r--. 1 root root 0 Sep 22 21:43 file4
-rw-r--r--. 1 root root 0 Sep 22 21:43 file5
</code></pre>

</article>



</div>
</div>
<script src="/js/theme.min.js" type="text/javascript"></script>


</body>
</html>

